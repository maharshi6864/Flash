<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GRE SRS Flashcards</title>
  <style>
    :root {
      --bg: #0b1220;
      --card: #111827;
      --ink: #e5e7eb;
      --muted: #9ca3af;
      --accent: #22d3ee;
      --good: #22c55e;
      --bad: #ef4444;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Helvetica, Arial;
      /* background: linear-gradient(180deg, #0b1220 0%, #0c1224 60%, #0f172a 100%); */
      background-color: #0b1220;
      color: var(--ink);
      min-height: 100vh;
    }

    .wrap {
      max-width: 640px;
      margin: 0 auto;
      padding: 16px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    header h1 {
      font-size: 20px;
      font-weight: 600;
    }

    .bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    select,
    button,
    input[type=file] {
      background: #0f172a;
      border: 1px solid #1f2937;
      color: var(--ink);
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 14px;
    }

    button {
      cursor: pointer;
    }

    button.good {
      border-color: #14532d;
    }

    button.bad {
      border-color: #7f1d1d;
    }

    button:active {
      transform: scale(0.97);
    }

    .card {
      background: var(--card);
      border: 1px solid #1f2937;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .25);
    }

    .meta {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 10px;
    }

    .tag {
      background: #0f172a;
      border: 1px solid #1f2937;
      border-radius: 6px;
      padding: 3px 8px;
    }

    .face {
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      min-height: 140px;
      border-radius: 10px;
      padding: 16px;
    }

    .front {
      font-size: 28px;
      font-weight: 700;
    }

    .back {
      font-size: 18px;
      line-height: 1.5;
      text-align: left;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 12px;
    }

    .controls button {
      flex: 1;
      min-width: 100px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>GRE Flashcards</h1>
      <div class="bar">
        <select id="listSelect">
          <option value="gre_list1.json">List 1</option>
        </select>
        <button id="loadBtn">Load</button>
        <input id="uploadInput" type="file" accept=".json" />
        <button id="exportBtn">Export</button>
        <button id="resetBtn">Reset</button>
      </div>
    </header>

    <section class="card">
      <div class="meta">
        <div>
          <span class="tag">Due: <span id="dueCount">0</span></span>
          <span class="tag">Mastered: <span id="masteredCount">0</span></span>
          <span class="tag">Total: <span id="totalCount">0</span></span>
        </div>
        <div>
          <span class="tag">Score: <span id="scoreBadge">0</span></span>
          <span class="tag">Reps: <span id="repsBadge">0</span></span>
        </div>
      </div>

      <div id="cardFace" class="face front">Load a list to begin</div>

      <div class="controls">
        <button id="revealBtn">Reveal</button>
        <button id="forgotBtn" class="bad">I Forgot</button>
        <button id="gotBtn" class="good">Got It</button>
        <button id="skipBtn">Skip</button>
        <button id="flipBtn">Flip</button>
      </div>
    </section>
  </div>

  <script>
    (() => {
      // ---------- Helpers
      const $ = sel => document.querySelector(sel);
      const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
      const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));
      const load = (k, f) => JSON.parse(localStorage.getItem(k) || JSON.stringify(f));

      // ---------- Elements
      const listSelect = $('#listSelect'), loadBtn = $('#loadBtn'),
        uploadInput = $('#uploadInput'), exportBtn = $('#exportBtn'), resetBtn = $('#resetBtn'),
        cardFace = $('#cardFace'), revealBtn = $('#revealBtn'), flipBtn = $('#flipBtn'),
        forgotBtn = $('#forgotBtn'), gotBtn = $('#gotBtn'), skipBtn = $('#skipBtn'),
        dueCount = $('#dueCount'), masteredCount = $('#masteredCount'),
        totalCount = $('#totalCount'), scoreBadge = $('#scoreBadge'), repsBadge = $('#repsBadge');

      // ---------- State
      let words = [], listName = 'gre_list1.json', progress = {};
      let flashing = [], learning = [], reviewing = [], pool = [];
      let currentKey = null, currentList = null, frontMode = load('srs_front_mode', 'word');
      let revealed = false, flashStreak = 0, flashesSinceReview = 0;
      const STORAGE_KEY = () => `srs_${listName}`;

      function setAnswerButtonsVisible(en) {
        gotBtn.style.display = en ? 'inline-block' : 'none';
        forgotBtn.style.display = en ? 'inline-block' : 'none';
        gotBtn.disabled = !en; forgotBtn.disabled = !en;
      }

      // ---------- Load/Init
      async function loadFromUrl(file) {
        listName = file;
        try {
          const res = await fetch(file, { cache: 'no-store' }); if (!res.ok) throw new Error();
          const data = await res.json(); onListLoaded(Array.isArray(data) ? data : (data.words || []));
        } catch (e) { alert("Couldn't load " + file + ". Use Upload instead."); }
      }

      function onListLoaded(data) {
        words = data; if (!Array.isArray(words) || !words.length) { alert("Invalid list."); return; }
        const keys = words.map(w => w.word); progress = load(STORAGE_KEY(), {});
        keys.forEach(k => {
          const p = progress[k] || {};
          progress[k] = {
            score: typeof p.score === 'number' ? clamp(p.score, -5, 10) : 0, reps: p.reps | 0,
            shows: p.shows | 0, answers: p.answers | 0, status: p.status || null, lastSeen: p.lastSeen || 0
          };
        });
        flashing = []; learning = []; reviewing = []; pool = [];
        keys.forEach(k => {
          const st = progress[k].status;
          if (st === 'flashing') flashing.push(k); else if (st === 'learning') learning.push(k);
          else if (st === 'reviewing') reviewing.push(k); else pool.push(k);
        });
        fillFlashingFromPool(); save(STORAGE_KEY(), progress); computeStats(); pickNext();
      }

      function fillFlashingFromPool() {
        while (flashing.length < 11 && pool.length > 0) {
          const k = pool.shift();
          flashing.push(k); progress[k].status = 'flashing';
        }
        save(STORAGE_KEY(), progress);
      }

      // ---------- Selection
      function pickNext() {
        if (flashesSinceReview >= 11 && reviewing.length) { currentList = 'reviewing'; flashesSinceReview = 0; currentKey = pickFrom(reviewing); }
        else if (flashStreak >= 5 && learning.length) { currentList = 'learning'; flashStreak = 0; currentKey = pickFrom(learning); }
        else if (flashing.length) { currentList = 'flashing'; currentKey = pickFrom(flashing); }
        else if (learning.length) { currentList = 'learning'; currentKey = pickFrom(learning); }
        else if (reviewing.length) { currentList = 'reviewing'; currentKey = pickFrom(reviewing); }
        else { currentKey = null; currentList = null; }
        renderFront();
      }

      function pickFrom(arr) {
        const ranked = arr.slice().sort((a, b) => {
          const pa = progress[a], pb = progress[b]; if (pa.score !== pb.score) return pa.score - pb.score;
          if (pa.lastSeen !== pb.lastSeen) return pa.lastSeen - pb.lastSeen; return pa.reps - pb.reps;
        });
        return ranked[Math.floor(Math.random() * Math.min(3, ranked.length))];
      }

      // ---------- Render
      function renderFront() {
        revealed = false; setAnswerButtonsVisible(false);
        if (!currentKey) { cardFace.className = 'face front'; cardFace.textContent = 'ðŸŽ‰ All done!'; return; }
        const w = words.find(x => x.word === currentKey), p = progress[currentKey];
        p.shows = (p.shows | 0) + 1; p.lastSeen = Date.now(); save(STORAGE_KEY(), progress);
        if (currentList === 'flashing') { flashStreak++; flashesSinceReview++; }
        cardFace.className = 'face front';
        cardFace.textContent = frontMode === 'word' ? w.word : (w.definition || 'â€”');
        scoreBadge.textContent = p.score; repsBadge.textContent = p.reps;
      }

      function reveal() {
        if (!currentKey) return; const w = words.find(x => x.word === currentKey);
        cardFace.className = 'face back';
        cardFace.innerHTML = `<div><div style="font-size:22px;font-weight:700;margin-bottom:8px">${w.word}</div>
          <div style="font-size:18px;line-height:1.5">${w.definition || 'â€”'}</div></div>`;
        revealed = true; setAnswerButtonsVisible(true);
      }

      function flipFrontBack() {
        frontMode = (frontMode === 'word' ? 'definition' : 'word'); save('srs_front_mode', frontMode);
        const cls = cardFace.className; if (cls.includes('front')) renderFront(); else reveal();
      }

      // ---------- Actions
      function onResult(delta) {
        if (!revealed || !currentKey) return; const p = progress[currentKey], pre = p.answers | 0;
        p.answers = pre + 1; p.reps = (p.reps | 0) + 1;
        if (currentList === 'flashing') {
          if (delta > 0 && pre === 0) p.score = clamp((p.score || 0) + 5, -5, 10); else p.score = clamp((p.score || 0) + delta, -5, 10);
          if (p.score >= 5) { flashing = flashing.filter(k => k !== currentKey); p.status = 'learning'; learning.push(currentKey); fillFlashingFromPool(); }
        } else if (currentList === 'learning') {
          if (delta > 0) { p.score = clamp((p.score || 0) + 1, -5, 10); if (p.score >= 10) { learning = learning.filter(k => k !== currentKey); p.status = 'reviewing'; reviewing.push(currentKey); } }
          else { learning = learning.filter(k => k !== currentKey); p.status = 'flashing'; p.score = 0; flashing.push(currentKey); }
        } else if (currentList === 'reviewing') { p.score = clamp((p.score || 0) + (delta > 0 ? 1 : -1), -5, 50); }
        save(STORAGE_KEY(), progress); computeStats(); pickNext();
      }

      function computeStats() {
        totalCount.textContent = words.length;
        masteredCount.textContent = Object.values(progress).filter(p => (p.score || 0) >= 5).length;
        dueCount.textContent = new Set([...flashing, ...learning, ...reviewing]).size;
      }

      function exportProgress() {
        const merged = words.map(w => ({ ...w, ...progress[w.word] }));
        const blob = new Blob([JSON.stringify(merged, null, 2)], { type: 'application/json' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
        a.download = listName.replace(/\.json$/, '') + '_progress.json'; a.click();
      }

      function resetAll() { if (!confirm('Reset?')) return; localStorage.removeItem(STORAGE_KEY()); onListLoaded(words); }

      // ---------- Wire
      loadBtn.onclick = () => loadFromUrl(listSelect.value);
      uploadInput.onchange = async e => {
        const f = e.target.files?.[0]; if (!f) return;
        listName = f.name; onListLoaded(JSON.parse(await f.text()));
      };
      exportBtn.onclick = exportProgress; resetBtn.onclick = resetAll;
      revealBtn.onclick = reveal; flipBtn.onclick = flipFrontBack;
      forgotBtn.onclick = () => onResult(-1); gotBtn.onclick = () => onResult(1); skipBtn.onclick = pickNext;

      setAnswerButtonsVisible(false); loadFromUrl(listSelect.value);
    })();
  </script>
</body>

</html>